<!DOCTYPE html>
<html>
<head>
    <title>Flask-SocketIO ZMQ Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js" integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.1.1/chartjs-plugin-zoom.min.js"></script>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>        
</head>
<body>
    <script type="text/javascript" charset="utf-8">
    $(document).ready(function() {

        // Global variables
        var socket = io();

        // Clear all the inputs at the start 
        var allInputs = document.querySelectorAll('input');
        allInputs.forEach(input => {
            if (input.type === 'text') {
                input.value = '';
            }
        });

        var elementMolecule = document.getElementById('visualization');
        var elementMoleculeOverlay = document.getElementById('visualization-overlay');
        var overlayContext = elementMoleculeOverlay.getContext('2d');
        
        var configMolecule = {
            backgroundColor: 'black',
            nomouse: true
        } 
        var viewerMolecule = $3Dmol.createViewer(elementMolecule, configMolecule);

        var isDrawing = false;
        var startPoint = null;
        var dx = null;
        var dy = null;
        var startPointOverlay = null;
        var dxOverlay = null;
        var dyOverlay = null;
        var mapObjectsToScreen = null;
        var selectedAtoms = [];

        var savedSelections = {};
        updateDynamicTable();

        // Defining custom listener when needed, forwarding to 3dmol.js otherwise

        // Event listener for mouse down (left click + Shift key)
        viewerMolecule.container.addEventListener('mousedown', (event) => {
            if (event.button === 0 && event.shiftKey) {
                startPoint = { x: event.clientX, y: event.clientY };

                console.log("Start point:", startPoint);
                if(viewerMolecule.getModel() != null)
                {
                    isDrawing = true;
                    mapObjectsToScreen = viewerMolecule.modelToScreen(viewerMolecule.getModel().getInternalState().atoms);
                    console.log("mapObjectsToScreen:", mapObjectsToScreen);
                    selectedAtoms = [];
                }
                else 
                {
                    console.log("Model is null");
                }
            }
            else {
                //console.log("Left button detected but not intercepted. Foward to 3Dmol.js");
                viewerMolecule._handleMouseDown(event);
            }
        });

        // Event listener for mouse move
        viewerMolecule.container.addEventListener('mousemove', (event) => {
            if (isDrawing) {
                // Calculate distance between current point and start point
                dx = event.clientX - startPoint.x;
                dy = event.clientY - startPoint.y;

                overlayContext.beginPath();
                //overlayContext.fillStyle = 'rgba(255, 0, 0, 0.5)';
                //overlayContext.fillRect(startPoint.x, startPoint.y, dx, dy);
                let rect3DMol = elementMolecule.getBoundingClientRect();
                overlayContext.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                overlayContext.rect(startPoint.x, startPoint.y, dx, dy);
                overlayContext.stroke();

                console.log("dx:", dx, "dy:", dy);
                console.log("Rect 3Dmol:", rect3DMol);

            }
            else 
            {
                //console.log("Mouse move detected but not intercepted. Foward to 3Dmol.js");
                viewerMolecule._handleMouseMove(event);
            }
        });

        // Event listener for mouse up
        viewerMolecule.container.addEventListener('mouseup', () => {
            if (isDrawing) {
                isDrawing = false;
                

                console.log(`Stopping drawing, will do the selection at this point within the rectangle. Looking for atoms between (${startPoint.x}, ${startPoint.y}) and (${startPoint.x + dx}, ${startPoint.y + dy})`);
                for(let i = 0; i < mapObjectsToScreen.length; i++)
                {
                    if(mapObjectsToScreen[i].x >= startPoint.x && mapObjectsToScreen[i].x <= startPoint.x + dx && mapObjectsToScreen[i].y >= startPoint.y && mapObjectsToScreen[i].y <= startPoint.y + dy)
                    {
                        selectedAtoms.push(i);
                    }
                }
                console.log("Selected atoms:", selectedAtoms);
                viewerMolecule.getModel().setStyle({'serial': selectedAtoms}, {'stick': {'color': 'yellow'}});
                viewerMolecule.render();

                // Updating the current selection field
                $('#current-selection').empty();
                if(selectedAtoms.length > 0)
                {
                    let strSelection = "";
                    for(let i = 0; i < selectedAtoms.length; i++)
                    {
                        strSelection += selectedAtoms[i] + " ";
                    }
                    document.getElementById('current-selection').value = strSelection;
                    console.log("Current selection:", strSelection);
                }
                
                startPoint = null;
            }
            else 
            {
                //console.log("Mouse up detected but not intercepted. Foward to 3Dmol.js");
                viewerMolecule._handleMouseUp(event);
            }
        });

        viewerMolecule.container.addEventListener('mousewheel', (event) => {
                //console.log("Mouse wheel detected but not intercepted. Foward to 3Dmol.js");
                viewerMolecule._handleMouseScroll(event);
        });

        viewerMolecule.container.addEventListener('DOMMouseScroll', (event) => {
                //console.log("DOM Mouse wheel detected but not intercepted. Foward to 3Dmol.js");
                viewerMolecule._handleMouseScroll(event);
        });

        // Forward events from the overlay to the molecule canvas
        elementMoleculeOverlay.addEventListener('mousedown', (event) => {
            viewerMolecule.container.dispatchEvent(new MouseEvent('mousedown', event)); // Forward to 3Dmol.js (not the molecule canvas) for selection event);
            if (event.button === 0 && event.shiftKey) {
                startPointOverlay = { x: event.clientX, y: event.clientY };
            }
        });
        elementMoleculeOverlay.addEventListener('mousemove', (event) => {
            viewerMolecule.container.dispatchEvent(new MouseEvent('mousemove', event));
            if(isDrawing)
            {
                // Get the rectangle of the canvas
                let rectOverlay = elementMoleculeOverlay.getBoundingClientRect();

                // Calculate the scale factor between the canvas and the bitmap
                let scaleX = elementMoleculeOverlay.width / rectOverlay.width;
                let scaleY = elementMoleculeOverlay.height /rectOverlay.height;
                dxOverlay = (event.clientX - startPointOverlay.x) * scaleX;
                dyOverlay = (event.clientY - startPointOverlay.y) * scaleY;

                // Substract the top left corner of the canvas from the startPoint
                let newStartPoint = {
                    x: (startPointOverlay.x - rectOverlay.left) * scaleX,
                    y: (startPointOverlay.y - rectOverlay.top) * scaleY
                }

                //overlayContext.fillStyle = 'rgba(255, 0, 0, 0.1)';
                //overlayContext.fillRect(newStartPoint.x, newStartPoint.y, dxOverlay, dyOverlay);
                overlayContext.clearRect(0, 0, elementMoleculeOverlay.width, elementMoleculeOverlay.height);
                overlayContext.beginPath();
                overlayContext.strokeStyle = 'rgba(255, 0, 0, 1.0)';
                overlayContext.rect(newStartPoint.x, newStartPoint.y, dxOverlay, dyOverlay);
                overlayContext.stroke();
                
                console.log("Rect overlay: ", rectOverlay, "scaleX:", scaleX, "scaleY:", scaleY);
            }
        });
        elementMoleculeOverlay.addEventListener('mouseup', (event) => {
            viewerMolecule.container.dispatchEvent(new MouseEvent('mouseup', event));
            if(!isDrawing)
            {
                // Clear the overlay
                overlayContext.clearRect(0, 0, elementMoleculeOverlay.width, elementMoleculeOverlay.height);
            }
        });
        elementMoleculeOverlay.addEventListener('mousewheel', (event) => {
            viewerMolecule.container.dispatchEvent(new MouseEvent('mousewheel', event));
        });
        elementMoleculeOverlay.addEventListener('DOMMouseScroll', (event) => {
            viewerMolecule.container.dispatchEvent(new MouseEvent('DOMMouseScroll', event));
        })



        var initWithBenzene = false;

        var xyzContent = "";
        var ffContent = "";
        var ffFileName = "";
        var motorConfigContent = "";

        // Handle example initialization for test purposes
        if (initWithBenzene) {
            let content = "12 \n\
 Atoms. Timestep: 0 \n\
C 53.88 52.15 50 \n\
C 53.18 53.36 50 \n\
C 51.78 53.36 50 \n\
C 51.08 52.15 50 \n\
C 51.78 50.94 50 \n\
C 53.18 50.94 50 \n\
H 54.96 52.15 50 \n\
H 53.72 54.3 50 \n\
H 51.24 54.3 50 \n\
H 50 52.15 50 \n\
H 51.24 50 50 \n\
H 53.72 50 50";
            viewerMolecule.addModel( content, "xyz");
            viewerMolecule.setStyle({}, {stick: {}})
            viewerMolecule.zoomTo();
            viewerMolecule.render();
        }

        // Handle file selection
        const input = document.getElementById('xyz-file');
        input.addEventListener('change', handleFileSelect, false);

        const inputFF = document.getElementById('ff-file');
        inputFF.addEventListener('change', handleForcefieldFileSelect, false);

        const inputMotor = document.getElementById('motor-file');
        inputMotor.addEventListener('change', handleMotorFileSelect, false);

        // Get the canvas element
        const canvas = document.getElementById('plot-canvas');
        const canvaTemp = document.getElementById('plot-canvas-temp');

        // Create a Chart.js instance
        const chart = new Chart(canvas, {
        type: 'line',
        data: {
            datasets: [{
            label: 'Timestep',
            data: [],
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2,
            fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    usePointStyle: true,
                },
                zoom: {
                    zoom: {
                        wheel: {
                            enabled: true,
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'x',
                    },
                    pan: {
                        enabled: true,
                        mode: 'x',
                    },
                    limits: {
                        x: {
                            minRange: 3
                        },
                    },
                }
            }
        }
        });
        const chartTemp = new Chart(canvaTemp, {
        type: 'line',
        data: {
            datasets: [{
            label: 'Temperature (K)',
            data: [],
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2,
            fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    usePointStyle: true,
                },
                zoom: {
                    zoom: {
                        wheel: {
                            enabled: true,
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'x',
                    },
                    pan: {
                        enabled: true,
                        mode: 'x',
                    },
                    limits: {
                        x: {
                            minRange: 3
                        },
                    },
                }
            }
        }
        });

        socket.on('zmq_message', function(data) {
            let msg = JSON.parse(data.message);
            console.log('Received ZMQ message on JS side:', data.message);


            if (!('global' in msg)) {
                console.log('The "global" key is not present in the msg');
                return;
            }


            //$('#log').append('<br>' + $('<div/>').text(msg['global']['step']).html());
            // Update the data in the chart instance
            chart.data.labels.push(msg['global']['simIt']);
            chart.data.datasets[0].data.push(msg['global']['simIt']);

            // Update the chart
            chart.update();

            chartTemp.data.labels.push(msg['global']['simIt']);
            chartTemp.data.datasets[0].data.push(msg['global']['temp']);

            // Update the chart
            chartTemp.update();

            // Find all fields
            
            function extractKeysAndValues(obj, parentKey = "") {
                let result = [];
                for (let key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        let newKey = parentKey ? parentKey + "." + key : key;
                        if (typeof obj[key] !== "object" || obj[key] === null) {
                            result.push({key: newKey, value: obj[key]});
                        }
                        else {
                            result = result.concat(extractKeysAndValues(obj[key], newKey));
                        }
                    }
                }
                return result;
            }
            
            //let keys = extractKeys(msg);
            let fields = extractKeysAndValues(msg);
            
            $('#fields-list').empty();
            $.each(fields, function(index, key) {
                $('#fields-list').append('<li>' + fields[index].key + ': ' + fields[index].value + '</li>');
            });
        });

        socket.on('zmq_message_atoms', function(data) {
            let msg = JSON.parse(data.message);
            //console.log('Received Atoms message on JS side:', msg);
            
            if (!('positions' in msg)) {
                console.log('The "positions" key is not present in the msg');
                return;
            }

            
            // Update the positions of the atoms in the viewer
            let positions = msg['positions'];
            console.log("Original positions:", positions);
            console.log("Original positions length:", positions.length);
            
            // Reshape the positions from 1D to 2D
            let reshapedPositions = [];
            while(positions.length > 0) reshapedPositions.push(positions.splice(0, 3));
            console.log("Reshaped positions:", reshapedPositions);
            console.log("Reshaped positions length:", reshapedPositions.length);


            viewerMolecule.getModel().setCoordinates(reshapedPositions, "array");
            viewerMolecule.animate({loop: "forward", reps:1});
            
            $('#info-sim-it').empty();
            $('#info-sim-it').append('Current Timestep: ' + msg['simIt']);
            viewerMolecule.render();
            
        });

        // Handlers for the different forms in the page.
        // These accept data from the user and send it to the server in a
        // variety of ways
        $('form#start_listening').submit(function(event) {
            socket.emit('start_listening');
            return false;
        });

        $('form#generate_inputs').submit(function(event) {
            console.log("Sending request to Generating inputs from javascript side");
            socket.emit('generate_inputs', {
                xyz: xyzContent,
                ff: ffContent,
                ffName: ffFileName,
                motors: motorConfigContent
            });
            return false;
        });

        $('form#launch_simulation').submit(function(event) {
            console.log("Sending request to launch the simulation from javascript side");
            socket.emit('launch_simulation', {
                xyz: xyzContent,
                ff: ffContent,
                ffName: ffFileName,
                motors: motorConfigContent
            });
            return false;
        });

        function handleFileSelect(evt) {
            console.log("XYZ File selected: " + evt.target.files[0].name);
            const file = evt.target.files[0];

            if (file) {
                const reader = new FileReader();
                // WTF is this? You have to give a lambda triggered if the load has been successful???
                // HELLOOOOO?
                reader.onload = function(event) {
                    const contents = event.target.result;
                    // Now you can parse the contents of the file
                    // For example, if the file is a JSON, you can parse it as follows:
                    console.log("File contents:", contents);

                    viewerMolecule.addModel(contents, 'xyz');
                    viewerMolecule.setStyle({}, {stick: {}})
                    viewerMolecule.zoomTo();
                    viewerMolecule.render();

                    xyzContent = contents;
                }
                reader.readAsText(file);
            }
            else 
            {
                console.log("No XYZ file was selected");
            }
        }

        // Function to create and update the dynamic table
        function updateDynamicTable() {
            const tableContainer = document.getElementById('dynamic-table-container');
            tableContainer.innerHTML = ''; // Clear previous content

            // Create a table element
            const table = document.createElement('table');
            table.className = 'dynamic-table';
            table.setAttribute('border', '1');

            // Create table header
            const headerRow = table.insertRow();
            const headers = ['Name', 'Number of Atoms', 'Color', 'Edit', 'Delete'];
            headers.forEach(headerText => {
                const header = document.createElement('th');
                header.textContent = headerText;
                headerRow.appendChild(header);
            });

            // Populate the table with saved selections
            Object.entries(savedSelections).forEach(([name, entry]) => {
                const row = table.insertRow();
                const cellName = row.insertCell();
                cellName.textContent = name;

                const cellNumAtoms = row.insertCell();
                cellNumAtoms.textContent = entry.atomIndexes.length;

                // You can customize the color representation based on the selection
                const cellColor = row.insertCell();
                //cellColor.textContent = 'PLACEHOLDER';
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = entry.color;
                colorInput.readOnly = true;
                cellColor.appendChild(colorInput);

                // Add Edit and Delete buttons
                const cellEdit = row.insertCell();
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                cellEdit.appendChild(editButton);

                const cellDelete = row.insertCell();
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                cellDelete.appendChild(deleteButton);
            });

            // Append the table to the container
            tableContainer.appendChild(table);
        }


        function handleForcefieldFileSelect(evt) {
            console.log("Forcefield File selected: " + evt.target.files[0].name);
            const file = evt.target.files[0];

            if (file) {
                const reader = new FileReader();

                reader.onload = function(event) {
                    const contents = event.target.result;
                    
                    console.log("Forcefield content:", contents);

                    ffContent = contents;
                    ffFileName = file.name;
                }
                reader.readAsText(file);
            }
            else 
            {
                console.log("No file was selected");
            }
        }

        function handleMotorFileSelect(evt) {
            console.log("Motor Config File selected: " + evt.target.files[0].name);
            const file = evt.target.files[0];

            if (file) {
                const reader = new FileReader();

                reader.onload = function(event) {
                    const contents = event.target.result;
                    
                    //console.log("Forcefield content:", contents);

                    motorConfigContent = contents;
                }
                reader.readAsText(file);
            }
            else 
            {
                console.log("No file was selected in motor configuration field.");
            }
        }

        // Make the function global so that it's accessible to the "save" button
        window.saveSelectionInternal = function() {
            if (selectedAtoms.length > 0 && document.getElementById('save-selection').value.length > 0) {
                savedSelections[document.getElementById('save-selection').value] = {
                    atomIndexes: selectedAtoms, 
                    name: document.getElementById('save-selection').value,
                    color: document.getElementById('selection-color').value};
                console.log("Added the selection " + document.getElementById('save-selection').value)

                // Update the table
                updateDynamicTable();
            }
            else 
            {
                console.log("No selection was selected or a name was not given")
            }
            console.log("Saved selections:", savedSelections);
        }

        window.refreshMolecule = function() {
            console.log("Refreshing the molecule");
            let vizStyle = document.getElementById("color-by").value;

            //<option value="atom-type">Atom Type</option>
            //<option value="selection">Selection</option>
            switch(vizStyle) {
                case "atom-type": {
                    viewerMolecule.setStyle({}, {stick: {}})
                    break;
                }
                case "selection": {
                    // We first color by atom type for every atoms, then we re-color by selection
                    viewerMolecule.setStyle({}, {stick: {}})
                    Object.entries(savedSelections).forEach(([name, entry]) => {
                        viewerMolecule.getModel().setStyle({'serial': entry.atomIndexes}, {'stick': {'color': entry.color}});
                    });
                    break;
                }
                default: {
                    viewerMolecule.setStyle({}, {stick: {}})
                    break;
                }
            }
            //viewerMolecule.getModel().setStyle({}, {'stick': {'color': 'yellow'}});
            //viewerMolecule.setStyle({}, {stick: {}})
            
            viewerMolecule.render();
        }
    });
    </script>
    <style>
        .left {
            float: left;
            width: 33%;
        }
        .middle {
            float: left;
            width: 33%;
        }
        .right {
            float: left;
            width: 33%;
        }

        #wrapper {
            position: relative;
        }

        #visualization {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0; /* Ensure it's above visualization-overlay */
            width: 100%;
            height: 400px;
        }

        #visualization-overlay {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; /* Ensure it's below visualization */
            width: 100%;
            height: 400px;
            /*background-color: rgba(196, 39, 135, 1); */
            background-color: rgba(0, 0, 0, 0);
        }

        #info {
            position: relative;
            top: 450px;
            left: 0;
        }

        #current-selection {
            width: 100%;
        }
    </style>
    <div class="left">
        <h1>Radahn Mega Frontend</h1>
        <p>
        Async mode is: <b>{{ async_mode }}</b><br>
        </p>
        <h2>Setup</h2>
        <div>
            <label for="xyz-file">Select XYZ file:</label>
            <input type="file" id="xyz-file" accept=".xyz">
        </div>
        <div>
            <label for="ff-file">Select Potential file:</label>
            <input type="file" id="ff-file" accept=".ff">
        </div>
        <div>
            <label for="motor-file">Select motor configuration file:</label>
            <input type="file" id="motor-file" accept=".json">
        </div>
        <div>
            <form id="start_listening" method="POST" action="#">
                <input type="submit" value="Start listening">
            </form>
        </div>
        <div>
            <form id="generate_inputs" method="POST" action="#">
                <input type="submit" value="Generate inputs">
            </form>
        </div>
        <div>
            <form id="launch_simulation" method="POST" action="#">
                <input type="submit" value="Launch">
            </form>
        </div>

    </div>
    <div class="middle">
        <h2>Plots</h2>
        <h2>Fields:</h2>
        <ul id="fields-list"></ul>
        <div id="log">
        <canvas id="plot-canvas"></canvas>
        </div>
        <div id="sep canvas">
        <canvas id="plot-canvas-temp"></canvas>
        </div>
    </div>
    <div class="right">
        <h2>Visualization:</h2>
        <div id="wrapper">  
            <div id="visualization" class="mol-container"></div>
            <canvas id="visualization-overlay" class="mol-overlay"></canvas>
            <div id="info">
                <label>Color by:</label>
                <select id="color-by">
                    <option value="atom-type">Atom Type</option>
                    <option value="selection">Selection</option>
                </select>
                <button id="toggle-atom-colors" onclick="refreshMolecule()">Update</button>
                <p id="info-sim-it">Current Timestep: 0</p>
                <label id="current-selection-label">Current Selection: </label>
                <input type="text" id="current-selection" name="current-selection" width="100%" readonly></input>
                <label>Save current selection as:</label>
                <input type="text" id="save-selection" name="save-selection"></input>
                <input type="color" id="selection-color" name="selection-color"></input>
                <button id="save-selection-button" onclick="saveSelectionInternal()">Save</button>
                <div id="dynamic-table-container"></div>
            </div>
        </div>
        
    </div>
</body>
</html>